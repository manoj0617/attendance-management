<%- layout("../layouts/adminBoilerplate") -%>
<body>
    <div class="container mt-5">
        <h1>Timetable Management</h1>

        <!-- Flash messages for success or error -->
        <% if (success && success.length) { %>
            <div class="alert alert-success"><%= success %></div>
        <% } %>
        <% if (error && error.length) { %>
            <div class="alert alert-danger"><%= error %></div>
        <% } %>

        <!-- Form to select Year, Branch, Section, and Semester -->
        <div class="selection-form mb-5">
            <h2>Select Timetable</h2>
            <form id="timetableForm">
                <div class="form-group">
                    <label for="year">Year</label>
                    <select id="year" name="year" class="form-control" required>
                        <option value="" disabled selected>Select Year</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="branch">Branch</label>
                    <select id="branch" name="branch" class="form-control" required disabled>
                        <option value="" disabled selected>Select Branch</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="section">Section</label>
                    <select id="section" name="section" class="form-control" required disabled>
                        <option value="" disabled selected>Select Section</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="semester">Semester</label>
                    <select id="semester" name="semester" class="form-control" required disabled>
                        <option value="" disabled selected>Select Semester</option>
                    </select>
                </div>
                <button type="button" id="viewTimetable" class="btn btn-primary mt-3" disabled>View Timetable</button>
                <button type="button" id="createTimetable" class="btn btn-success mt-3" disabled>Create New Timetable</button>
            </form>
        </div>

        <!-- Timetable display and period creation -->
        <div id="timetableContainer" style="display:none;">
            <h2>Class Timetable</h2>
            <table class="table table-bordered mt-5">
                <thead>
                    <tr>
                        <th>Day</th>
                        <% for (let i = 1; i <= 7; i++) { %>
                            <th>Period <%= i %></th>
                        <% } %>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>

        <!-- Modal for creating new period -->
        <div class="modal fade" id="createPeriodModal" tabindex="-1" aria-labelledby="createPeriodModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createPeriodModalLabel">Create New Period</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createPeriodForm">
                            <input type="hidden" id="modalDay" name="day">
                            <input type="hidden" id="modalHour" name="hour">
                            <input type="hidden" id="modalSection" name="section">
                            <input type="hidden" id="modalBranch" name="branch">
                            <input type="hidden" id="modalSemester" name="semester">
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject</label>
                                <select id="modalSubject" name="subject" class="form-control" required>
                                    <option value="" disabled selected>Select Subject</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="faculty" class="form-label">Faculty</label>
                                <select id="modalFaculty" name="faculty" class="form-control" required>
                                    <option value="" disabled selected>Select Faculty</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="startTime" class="form-label">Start Time</label>
                                <input type="text" id="modalStartTime" name="startTime" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="endTime" class="form-label">End Time</label>
                                <input type="text" id="modalEndTime" name="endTime" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fetch academic years and populate the year dropdown
        fetch('/admin/academic-year')
            .then(response => response.json())
            .then(academicYears => {
                const yearSelect = document.getElementById('year');
                academicYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year._id;
                    option.textContent = year.name;
                    yearSelect.appendChild(option);
                });
            });

        document.getElementById('year').addEventListener('change', function() {
            const year = this.value;
            fetch(`/admin/branch?year=${year}`)
                .then(response => response.json())
                .then(branches => {
                    const branchSelect = document.getElementById('branch');
                    branchSelect.innerHTML = '<option value="" disabled selected>Select Branch</option>';
                    branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch._id;
                        option.textContent = branch.name;
                        branchSelect.appendChild(option);
                    });
                    branchSelect.disabled = false;
                });
        });

        document.getElementById('branch').addEventListener('change', function() {
            const branch = this.value;
            fetch(`/admin/sections?branch=${branch}`)
                .then(response => response.json())
                .then(sections => {
                    const sectionSelect = document.getElementById('section');
                    sectionSelect.innerHTML = '<option value="" disabled selected>Select Section</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section._id;
                        option.textContent = section.name;
                        sectionSelect.appendChild(option);
                    });
                    sectionSelect.disabled = false;
                });
        });

        document.getElementById('section').addEventListener('change', function() {
            const section = this.value;
            fetch(`/admin/semester?section=${section}`)
                .then(response => response.json())
                .then(semesters => {
                    const semesterSelect = document.getElementById('semester');
                    semesterSelect.innerHTML = '<option value="" disabled selected>Select Semester</option>';
                    semesters.forEach(semester => {
                        const option = document.createElement('option');
                        option.value = semester._id;
                        option.textContent = semester.name;
                        semesterSelect.appendChild(option);
                    });
                    semesterSelect.disabled = false;
                });
        });

        document.getElementById('semester').addEventListener('change', function() {
            document.getElementById('viewTimetable').disabled = false;
            document.getElementById('createTimetable').disabled = false;
        });

        document.getElementById('viewTimetable').addEventListener('click', function() {
            const section = document.getElementById('section').value;
            fetch(`/admin/timetable?section=${section}`)
                .then(response => response.json())
                .then(data => {
                    const timetableContainer = document.getElementById('timetableContainer');
                    const timetableBody = document.getElementById('timetableBody');
                    timetableBody.innerHTML = '';

                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    days.forEach(day => {
                        const row = document.createElement('tr');
                        const dayCell = document.createElement('td');
                        dayCell.textContent = day;
                        row.appendChild(dayCell);

                        for (let i = 1; i <= 7; i++) {
                            const periodCell = document.createElement('td');
                            const period = data.periods.find(p => p.day === day && p.hour === i);

                            if (period) {
                                periodCell.innerHTML = `
                                    ${period.subject}
                                    <form method="post" action="/admin/timetable/${period._id}?_method=DELETE" onsubmit="return confirm('Are you sure you want to delete this period?');">
                                        <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                                    </form>
                                `;
                            } else {
                                const addPeriodButton = document.createElement('button');
                                addPeriodButton.textContent = 'Add Period';
                                addPeriodButton.className = 'btn btn-success btn-sm';
                                addPeriodButton.dataset.day = day;
                                addPeriodButton.dataset.hour = i;
                                addPeriodButton.dataset.section = section;
                                addPeriodButton.dataset.branch = document.getElementById('branch').value;
                                addPeriodButton.dataset.semester = document.getElementById('semester').value;

                                addPeriodButton.addEventListener('click', function() {
                                    const day = this.dataset.day;
                                    const hour = this.dataset.hour;
                                    const section = this.dataset.section;
                                    const branch = this.dataset.branch;
                                    const semester = this.dataset.semester;

                                    document.getElementById('modalDay').value = day;
                                    document.getElementById('modalHour').value = hour;
                                    document.getElementById('modalSection').value = section;
                                    document.getElementById('modalBranch').value = branch;
                                    document.getElementById('modalSemester').value = semester;

                                    fetch(`/admin/subjects?branch=${branch}&semester=${semester}`)
                                        .then(response => response.json())
                                        .then(subjects => {
                                            const subjectSelect = document.getElementById('modalSubject');
                                            subjectSelect.innerHTML = '<option value="" disabled selected>Select Subject</option>';
                                            subjects.forEach(subject => {
                                                const option = document.createElement('option');
                                                option.value = subject._id;
                                                option.textContent = subject.name;
                                                subjectSelect.appendChild(option);
                                            });
                                        });

                                    fetch('/admin/faculty')
                                        .then(response => response.json())
                                        .then(faculties => {
                                            const facultySelect = document.getElementById('modalFaculty');
                                            facultySelect.innerHTML = '<option value="" disabled selected>Select Faculty</option>';
                                            faculties.forEach(faculty => {
                                                const option = document.createElement('option');
                                                option.value = faculty._id;
                                                option.textContent = faculty.name;
                                                facultySelect.appendChild(option);
                                            });
                                        });

                                    const modalStartTime = document.getElementById('modalStartTime');
                                    const modalEndTime = document.getElementById('modalEndTime');
                                    modalStartTime.value = '';
                                    modalEndTime.value = '';

                                    const createPeriodModal = new bootstrap.Modal(document.getElementById('createPeriodModal'));
                                    createPeriodModal.show();
                                });

                                periodCell.appendChild(addPeriodButton);
                            }
                            row.appendChild(periodCell);
                        }
                        timetableBody.appendChild(row);
                    });

                    timetableContainer.style.display = 'block';
                });
        });

        document.getElementById('createPeriodForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());

            fetch('/admin/timetable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert('Period created successfully');
                        window.location.reload();
                    } else {
                        alert('Error creating period: ' + result.message);
                    }
                });
        });

        document.getElementById('createTimetable').addEventListener('click', function() {
            const section = document.getElementById('section').value;
            const year = document.getElementById('year').value;
            const semester = document.getElementById('semester').value;
            const branch = document.getElementById('branch').value;
            const numPeriods = prompt("Enter the number of periods for the day:");
            const numDays=7;
        // Check if both inputs are valid
        if (!isNaN(numPeriods) && !isNaN(numDays)) {
            // Redirect to the new timetable page with query parameters
            window.location.href = `/admin/timetable/new?numPeriods=${numPeriods}&branch=${branch}&numDays=${numDays}&semester=${semester}&year=${year}&section=${section}`;
        } else {
            alert('Invalid input. Please enter a valid number.');
        }
    });

        
    </script>
</body>
